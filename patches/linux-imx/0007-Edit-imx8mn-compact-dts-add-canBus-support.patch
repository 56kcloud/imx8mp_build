From 90d72a48db6e55cca6994da45ff7b1e76a60b49d Mon Sep 17 00:00:00 2001
From: Yazan Shhady <yazan.shhady@solid-run.com>
Date: Thu, 29 Apr 2021 14:16:28 +0300
Subject: [PATCH] Edit imx8mn compact dts: add canBus support

---
 .../boot/dts/freescale/imx8mn-compact.dts     | 66 +++++--------------
 1 file changed, 17 insertions(+), 49 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/imx8mn-compact.dts b/arch/arm64/boot/dts/freescale/imx8mn-compact.dts
index 4f426d460cd1..6a7aefce82ac 100755
--- a/arch/arm64/boot/dts/freescale/imx8mn-compact.dts
+++ b/arch/arm64/boot/dts/freescale/imx8mn-compact.dts
@@ -55,6 +55,14 @@
 		enable-active-high;
 	};
 
+	clocks {
+		clk40m: clk40m {
+			compatible = "fixed-clock";
+			#clock-cells = <0>;
+			clock-frequency = <40000000>;
+		};
+	};
+
 };
 
 &iomuxc {
@@ -105,24 +113,6 @@
                 >;
         };
 
-
-	pinctrl_ecspi2: ecspi2grp {
-		fsl,pins = <
-        	      MX8MN_IOMUXC_ECSPI2_SCLK_ECSPI2_SCLK            0x82
-                      MX8MN_IOMUXC_ECSPI2_MOSI_ECSPI2_MOSI            0x82
-                      MX8MN_IOMUXC_ECSPI2_MISO_ECSPI2_MISO            0x82
-		      MX8MN_IOMUXC_ECSPI2_SS0_GPIO5_IO13              0x40000 /*SPI CS*/
-		>;
-	};	
-
-        pinctrl_can: cangrp {
-                fsl,pins = <
-        	       //MX51_PAD_CSI2_PIXCLK__GPIO4_15          0x80000000      /* nReset */
-                       //MX51_PAD_GPIO1_1__GPIO1_1               0x80000000      /* IRQ */
-                >;
-        };
-
-
 	pinctrl_mipi_dsi_en: mipi_dsi_en {
 		fsl,pins = <
 			MX8MN_IOMUXC_GPIO1_IO08_GPIO1_IO8		0x16
@@ -679,46 +669,24 @@
 	status = "okay";
 };
 
-&ecspi2 {
-        num-cs = <1>;
-        status = "okay";
-        cs-gpios = <&gpio2 10 0>, <0>;
-        pinctrl-0 = <&pinctrl_solidsense_ecspi2>;
-
-        spidev0: spi@0 {
-                compatible = "analog,mp-ind-eth";
-                reg = <0>;
-                spi-max-frequency = <200000000>;
-        };
-
-};
-
-
-
 &ecspi2 {
         pinctrl-names = "default";
         pinctrl-0 = <&pinctrl_ecspi2>;
+        fsl,spi-num-chipselects = <1>;
         cs-gpios = <&gpio5 13 GPIO_ACTIVE_LOW>; //GPIO5_IO13
         status = "okay";
-	
-	spidev0: spi@0 {
-        	compatible = "microchip,mcp2515";
-                reg = <0>;
-                spi-max-frequency = <200000000>;
-        };
-/*
+        #address-cells = <1>;
+        #size-cells = <0>;
+
         can0: can@0 {
+                clocks = <&clk40m>;
+                compatible = "microchip,mcp25xxfd";             
                 pinctrl-names = "default";
-                //pinctrl-0 = <&pinctrl_can>;
-                compatible = "microchip,mcp2515";
                 reg = <0>;
-                clocks = <&clk24M>;
-                spi-max-frequency = <10000000>;
-                //interrupt-parent = <&gpio1>;
-                interrupts = <1 IRQ_TYPE_EDGE_FALLING>;
-                //vdd-supply = <&reg_can>;
+                spi-max-frequency = <20000000>;
+                interrupt-parent = <&gpio5>;
+                interrupts = <1 IRQ_TYPE_LEVEL_LOW>;
         };
-*/
 };
 
 
-- 
2.25.1

